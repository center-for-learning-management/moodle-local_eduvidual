define(["jquery","core/ajax","core/notification","core/str","core/url","local_eduvidual/main"],function(A,u,c,e,I,a){return{debug:1,debug_gps:1,cache_orgs:{},refresh_identifier:0,varcache:undefined,blockfooter:function(e){if(this.debug>0)console.log("ADMIN.blockfooter()");require(["local_eduvidual/main"],function(e){e.watchValue({target:"#local_eduvidual_admin_blockfooter",run:function(){var a=this;require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"blockfooter",blockfooter:A(a.target).val()},{signalItem:A(a.target)})})}})})},coursedeleteform:function(e,a){var r=Math.round(A("#"+a+" select[name=size]").val());var i=Math.round(A("#"+a+" input[name=from]").val());var o=e=="next"?i+r:i-r;if(o<0)o=0;A("#"+a+" input[name=from]").val(o);A("#"+a+" form").submit()},manageorgs_open:function(e,a){var r=A("#"+e+"-form");A(r).find(".local_eduvidual_signal_error").removeClass("local_eduvidual_signal_error");var i=this.cache_orgs[a];if(typeof i!=="undefined"){var o=Object.keys(i);for(var n=0;n<o.length;n++){var t=o[n];A("#"+e+"-field-"+t).attr("data-orig",i[t]).val(i[t])}A("#"+e+"-field-manage").attr("data-orig",i["orgid"])}else{r.find("input").val("").attr("data-orig","")}if(typeof i!=="undefined"&&typeof i["categoryid"]!=="undefined"&&i["categoryid"]>0){A("#"+e+"-field-orgid").attr("readonly","readonly");A("#"+e+"-field-categoryid").css("display","block");A("#"+e+"-field-manage").css("display","block")}else{A("#"+e+"-field-orgid").removeAttr("readonly");A("#"+e+"-field-categoryid").css("display","none");A("#"+e+"-field-manage").css("display","none")}},manageorgs_reset:function(e){this.manageorgs_open(e,0)},manageorgs_search:function(r){require(["local_eduvidual/main"],function(e){e.watchValue({target:"#"+r+"-search",run:function(){var a=this;require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"manageorgs_search",search:A(a.target).val()},{signalItem:A(a.target),uniqid:r})})}})})},manageorgs_store:function(a){var e=A("#"+a+"-form");A(e).find(".local_eduvidual_signal_error").removeClass("local_eduvidual_signal_error");var r={};e.find("input").each(function(){if(typeof A(this).attr("id")!=="undefined"&&A(this).attr("id")!=""){var e=A(this).attr("id").replace(a+"-field-","");r[e]=A(this).val()}});require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"manageorgs_store",fields:r},{signalItem:A("#"+a+"-store"),uniqid:a})})},navbar:function(){if(this.debug>0)console.log("ADMIN.navbar()");require(["local_eduvidual/main"],function(e){e.watchValue({target:"#local_eduvidual_admin_navbar",run:function(){var a=this;require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"navbar",navbar:A(a.target).val()},{signalItem:A(a.target)})})}})})},modifylogin:function(a){if(this.debug>0)console.log("ADMIN.modifylogin(setto)",a);require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"modifylogin",setto:a},{signalItem:A("#local_eduvidual_admin_modifylogin")})})},org_gps:function(a,e,r,i,o){var n=this;n.refresh_identifier++;var t=n.refresh_identifier;if(typeof a==="undefined")a=A(".local_eduvidual_admin_map").attr("id");if(typeof e==="undefined")e=-200;if(typeof r==="undefined")r=200;if(typeof i==="undefined")i=-200;if(typeof o==="undefined")o=200;console.log("ADMIN.org_gps(uniqid, lon1, lon2, lat1, lat2)",a,e,r,i,o);var l=A("#"+a+"-include-nonegroup").prop("checked")?1:0;var s="local_eduvidual_admin_org_gps";var d={lon1:e,lon2:r,lat1:i,lat2:o,includenonegroup:l,advanceddata:0};if(typeof n.map!=="undefined"){n.map.remove()}if(n.debug_gps)console.log("Sending to "+s,d);u.call([{methodname:s,args:d,done:function(e){if(n.refresh_identifier!=t)return;try{e=JSON.parse(e)}catch(e){}if(n.debug_gps)console.log("Got response",e);n.orgs=e;n.org_gps_list(a)},fail:c.exception}])},org_gps_bounds:function(e){var a=this;if(typeof a.map==="undefined")return;var r=a.map.getBounds().toBBoxString().split(",");if(a.debug_gps)console.log("Setting bounds to",r);A("#"+e).attr("data-lon1",r[0]);A("#"+e).attr("data-lon2",r[2]);A("#"+e).attr("data-lat1",r[1]);A("#"+e).attr("data-lat2",r[3]);if(typeof a.map_moved==="undefined"){a.map_moved=0}else{a.map_moved++;var i=a.map_moved;setTimeout(function(){if(i==a.map_moved){a.org_gps_refresh(e)}},1e3)}},org_gps_list:function(r){var o=this;if(o.debug_gps)console.log("ADMIN.org_gps_list(uniqid)",r);if(typeof o.map!=="undefined"){o.map.remove()}var n=o.refresh_identifier;var t=A("#"+r+"-include-nonegroup").prop("checked")?1:0;A("#"+r+"-legend td.none").parent().css("display",t?"table-row":"none");A("#"+r+"-legend-none").css("display",t?"inline-block":"none");var l=o.orgs;var e=new Date(A("#"+r+"-year").val(),A("#"+r+"-month").val()-1,A("#"+r+"-day").val(),A("#"+r+"-hour").val(),A("#"+r+"-minute").val(),A("#"+r+"-second").val(),0);A("#"+r+"-second").val(e.getSeconds());A("#"+r+"-minute").val(e.getMinutes());A("#"+r+"-hour").val(e.getHours());A("#"+r+"-day").val(e.getDate());A("#"+r+"-month").val(e.getMonth()+1);A("#"+r+"-year").val(e.getFullYear());var s=Math.floor(e.getTime()/1e3);var d=200;var u=200;var c=-200;var f=-200;var g={both:0,eduv:0,none:0};var i=[L.layerGroup(),L.layerGroup(),L.layerGroup(),L.layerGroup()];var p={0:"",1:"Burgenland",2:"Kärnten",3:"Niederösterreich",4:"Oberösterreich",5:"Salzburg",6:"Steiermark",7:"Tirol",8:"Vorarlberg",9:"Wien"};var m={0:"Sonstige",1:"VS",2:"MS",3:"Sonderschule",4:"PTS",5:"BS",6:"Gymnasium",7:"HTL",8:"HAK",9:"HUM"};Object.keys(l).forEach(function(e){console.log("refresh_identifier",o.refresh_identifier,n);if(o.refresh_identifier!=n)return;l[e].url=I.relativeUrl("/local/eduvidual/pages/myorgs.php?orgid="+l[e].orgid);var a=l[e].orgid.toString().split("").pop();var r=l[e].orgid.toString().split("")[0];l[e].classes=m[a]+" "+p[r];var i="red";l[e].ignore=false;if(l[e].authenticated>0&&l[e].authenticated<s&&l[e].lpf!=null){i="orange";g.both++;l[e].classes+=" both";l[e].layer=2;l[e].url=I.relativeUrl("/local/eduvidual/pages/myorgs.php?orgid="+l[e].orgid)}else if(l[e].authenticated>0&&l[e].authenticated<s){i="green";g.eduv++;l[e].classes+=" eduv";l[e].layer=3;l[e].url=I.relativeUrl("/local/eduvidual/pages/myorgs.php?orgid="+l[e].orgid)}else if(t==1){i="lightgray";g.none++;l[e].classes+=" none invisible";l[e].layer=0;l[e].url=""}else{l[e].ignore=true}if(i!="lightgray"&&a>0){if(l[e].lon<u)u=l[e].lon;if(l[e].lon>f)f=l[e].lon;if(l[e].lat<d)d=l[e].lat;if(l[e].lat>c)c=l[e].lat}l[e].marker=I.relativeUrl("/local/eduvidual/pix/google-maps-pin-"+i+".svg#"+l[e].classes+"#"+l[e].layer)});d=45.18189988240382;u=8.88805461218309;c=49.517950306694665;f=17.45739054968309;var a=[[d,u],[c,f]];var v=(d+c)/2;var h=(u+f)/2;var _=[v,h];if(o.debug_gps)console.log("Bounds",a);if(o.debug_gps)console.log("Center",_);var y=A("#"+r+"-map").width();if(o.debug_gps)console.log("Width",y);if(o.debug_gps)console.log("Height",y/4*3);A("#"+r+"-map").css("height",y/4*3+"px");var b=L.icon({iconUrl:I.relativeUrl("/local/eduvidual/pix/google-maps-pin-blue.svg"),iconRetinaUrl:I.relativeUrl("/local/eduvidual/pix/google-maps-pin-blue.svg"),iconSize:[29,24],iconAnchor:[9,21],popupAnchor:[0,-14]});Object.keys(l).forEach(function(e){if(o.refresh_identifier!=n)return;if(l[e].ignore)return;var a=b;if(typeof l[e].marker!=="undefined"&&l[e].marker!=""){a=L.icon({iconUrl:l[e].marker,iconRetinaUrl:l[e].marker,iconSize:[29,24],iconAnchor:[9,21],popupAnchor:[0,-14]})}var r=L.marker([l[e].lat,l[e].lon],{icon:a}).bindPopup(typeof l[e].url!=="undefined"&&l[e].url!=""?'<a href="'+l[e].url+'" target="_blank">'+l[e].name+" ("+e+")</a>":l[e].name);r.addTo(i[l[e].layer])});var k=[e.getFullYear(),String(e.getMonth()+1).padStart(2,"0"),String(e.getDate()).padStart(2,"0")].join("-");var q=1/9*6;var S="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";var w="Visualisierung der Moodle-Schulen in Österreich | "+k+' | <a href="https://www.lernmanagement.at" target="_blank">Zentrum für Lernmanagement</a> | powered by &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>';o.map=L.map(r+"-map",{boxZoom:true,center:_,layers:i,zoom:14,zoomControl:false,zoomSnap:.5});o.map.fitBounds(a,{maxZoom:18});o.map.on("moveend",function(e){o.org_gps_bounds(r)});o.map.on("resize",function(e){if(o.debug_gps)console.log("Map was resized",e);var a=A("#"+r+"-map").width();if(o.debug_gps)console.log("Width",a);if(o.debug_gps)console.log("Height",a*q);A("#"+r+"-map").css("height",a*q+"px")});var M={normal:L.tileLayer(S,{attribution:w,id:"mapbox.normal",subdomains:["a","b","c"]})};M["normal"].addTo(o.map);L.control.zoom({position:"bottomright"}).addTo(o.map);A("#"+r+" .leaflet-marker-pane img").each(function(e,a){if(o.refresh_identifier!=n)return;var r=A(a).attr("src");var i=r.split("#");if(i.length==3){A(a).addClass(i[1].replace(","," "));A(a).css("z-index",990+i[2])}});A("#"+r+"-map").css("height",A("#"+r+"-map").width()*q+"px");o.org_gps_bounds(r);o.org_gps_refresh(r)},org_gps_refresh:function(l){var s=this;s.refresh_identifier++;var d=s.refresh_identifier;console.log("ADMIN.org_gps_refresh(uniqid)",l);var o=A("#"+l+"-map");A("#"+l+"-map .leaflet-marker-icon").each(function(e,a){if(s.refresh_identifier!=d)return;var r=a.style.transform.split(/\w+\(|\);?/);if(r.length==3){var i=r[1].split("px").join("").split(" ").join("").split(",")}if(i.length==3){if(i[0]<0||i[0]>o.width()||i[1]<0||i[1]>o.height()){A(a).addClass("out-of-bounds")}else{A(a).removeClass("out-of-bounds")}}});A("#"+l+"-map .leaflet-marker-icon").addClass("flag-visible");A("#"+l+"-legend .trigger").each(function(e,a){if(s.refresh_identifier!=d)return;var r=A(a).attr("data-trigger-key");if(typeof r!=="undefined"&&r!==""){var i=A(a).prop("checked");if(!i){A("#"+l+"-map .leaflet-marker-icon."+r).removeClass("flag-visible")}}});A("#"+l+"-map .leaflet-marker-icon:not(.flag-visible)").addClass("invisible");A("#"+l+"-map .leaflet-marker-icon.flag-visible").removeClass("invisible");var u=A("#"+l+"-count-invisibles").prop("checked");var c={};A("#"+l+"-legend .trigger").each(function(e,a){if(s.refresh_identifier!=d)return;var r=A(a).attr("data-trigger-key");var i=A(a).attr("data-filterid");if(typeof r!=="undefined"&&r!==""){var o=A(a).prop("checked");var n=0;var t=A("#"+l+"-map .leaflet-marker-icon."+r+":not(.out-of-bounds)");if(u){n=t.length}else if(o){n=t.not(".invisible").length}A("#"+l+"-legend td."+r).html(n);if(typeof i!=="undefined"&&i!=""){if(typeof c[i]==="undefined")c[i]=0;c[i]+=n}}});Object.keys(c).forEach(function(e){A("#"+l+"-legend table."+e+" td.sum").html(c[e])})},questioncategories:function(a,e){if(this.debug>0)console.log("ADMIN.questioncategories(uniqid, catid)",a,e);var r=A(".questioncategory-"+a+"-"+e);var i=new Array;var o=new Array;A.each(A(".questioncategories-"+a+":checked"),function(){var e=A(this).val();i.push(e);o.push(A(".supportcourses-"+a+"-"+e).val())});require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"questioncategories",questioncategories:i,supportcourses:o},{signalItem:A(r)})})},requireCapability:function(a){if(this.debug>0)console.log("ADMIN.requireCapability(val)",a);require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"requirecapability",requirecapability:a},{signalItem:A("#local_eduvidual_admin_requirecapability")})})},result:function(e){if(e.data.act=="blockfooter"){A("#local_eduvidual_footer").html(e.data.blockfooter)}if(e.data.act=="coursebasements"){p;history.go(0)}if(e.data.act=="manageorgs_search"){if(typeof e.result.status!=="undefined"&&e.result.status=="ok"){var a=A("#"+e.payload.uniqid+"-list").empty();this.cache_orgs=e.result.orgs;if(e.result.orgs.length===0){a.append(A("<li>").html("No results"))}else{var r=Object.keys(e.result.orgs);for(var i=0;i<r.length;i++){var o=e.result.orgs[r[i]];a.append(A("<li>").append(A("<a>").html(o.name+" ("+o.orgid+")").attr("href","#").attr("onclick","require(['local_eduvidual/admin'], function(ADMIN) { ADMIN.manageorgs_open('"+e.payload.uniqid+"', "+o.id+"); });")))}}}}if(e.data.act=="manageorgs_store"){if(typeof e.result.errors!=="undefined"&&e.result.errors.length>0){for(var i=0;i<e.result.errors.length;i++){var n=e.result.errors[i];A("#"+e.payload.uniqid+"-field-"+n).addClass("local_eduvidual_signal_error")}}}},statsSwitchColumn:function(e,a){console.log("ADMIN.statsSwitchColumn(uniqid, sender)",e,a);var r=A(a).attr("data-type");var i=A("."+e+"-"+r);var o=A(a).prop("checked")?"block":"none";i.css("display",o)}}});