define(["jquery","core/ajax","core/notification","core/str","core/url","local_eduvidual/main"],function(w,s,c,e,D,a){return{debug:1,debug_gps:1,cache_orgs:{},refresh_identifier:0,varcache:undefined,blockfooter:function(e){if(this.debug>0)console.log("ADMIN.blockfooter()");require(["local_eduvidual/main"],function(e){e.watchValue({target:"#local_eduvidual_admin_blockfooter",run:function(){var a=this;require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"blockfooter",blockfooter:w(a.target).val()},{signalItem:w(a.target)})})}})})},coursebasements:function(a){if(this.debug>0)console.log("ADMIN.coursebasements()");var o={module:"admin",act:"coursebasements",courseempty:w("#local_eduvidual_admin_coursebasements_courseempty").val(),courserestore:w("#local_eduvidual_admin_coursebasements_courserestore").val(),coursetemplate:w("#local_eduvidual_admin_coursebasements_coursetemplate").val()};require(["local_eduvidual/main"],function(e){e.connect(o,{signalItem:w(a)})})},coursedeleteform:function(e,a){var o=Math.round(w("#"+a+" select[name=size]").val());var r=Math.round(w("#"+a+" input[name=from]").val());var i=e=="next"?r+o:r-o;if(i<0)i=0;w("#"+a+" input[name=from]").val(i);w("#"+a+" form").submit()},defaultrole:function(a,o){if(this.debug>0)console.log("ADMIN.defaultrole(type, role)",a,o);require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"defaultrole",type:a,role:o},{signalItem:w("#local_eduvidual_admin_defaultrole"+a)})})},dropZonePath:function(){if(this.debug>0)console.log("ADMIN.dropZonePath()");require(["local_eduvidual/main"],function(e){e.watchValue({target:"#local_eduvidual_admin_dropzonepath",run:function(){var a=this;require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"dropzonepath",dropzonepath:w(a.target).val()},{signalItem:w(a.target)})})}})})},ltiresourcekey:function(){if(this.debug>0)console.log("ADMIN.ltiresourcekey()");require(["local_eduvidual/main"],function(e){e.watchValue({target:"#local_eduvidual_admin_ltiresourcekey",run:function(){var a=this;require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"ltiresourcekey",ltiresourcekey:w(a.target).val()},{signalItem:w(a.target)})})}})})},manageorgs_open:function(e,a){var o=w("#"+e+"-form");w(o).find(".local_eduvidual_signal_error").removeClass("local_eduvidual_signal_error");var r=this.cache_orgs[a];if(typeof r!=="undefined"){var i=Object.keys(r);for(var t=0;t<i.length;t++){var n=i[t];w("#"+e+"-field-"+n).attr("data-orig",r[n]).val(r[n])}w("#"+e+"-field-manage").attr("data-orig",r["orgid"])}else{o.find("input").val("").attr("data-orig","")}if(typeof r!=="undefined"&&typeof r["categoryid"]!=="undefined"&&r["categoryid"]>0){w("#"+e+"-field-orgid").attr("readonly","readonly");w("#"+e+"-field-categoryid").css("display","block");w("#"+e+"-field-manage").css("display","block")}else{w("#"+e+"-field-orgid").removeAttr("readonly");w("#"+e+"-field-categoryid").css("display","none");w("#"+e+"-field-manage").css("display","none")}},manageorgs_reset:function(e){this.manageorgs_open(e,0)},manageorgs_search:function(o){require(["local_eduvidual/main"],function(e){e.watchValue({target:"#"+o+"-search",run:function(){var a=this;require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"manageorgs_search",search:w(a.target).val()},{signalItem:w(a.target),uniqid:o})})}})})},manageorgs_store:function(a){var e=w("#"+a+"-form");w(e).find(".local_eduvidual_signal_error").removeClass("local_eduvidual_signal_error");var o={};e.find("input").each(function(){if(typeof w(this).attr("id")!=="undefined"&&w(this).attr("id")!=""){var e=w(this).attr("id").replace(a+"-field-","");o[e]=w(this).val()}});require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"manageorgs_store",fields:o},{signalItem:w("#"+a+"-store"),uniqid:a})})},navbar:function(){if(this.debug>0)console.log("ADMIN.navbar()");require(["local_eduvidual/main"],function(e){e.watchValue({target:"#local_eduvidual_admin_navbar",run:function(){var a=this;require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"navbar",navbar:w(a.target).val()},{signalItem:w(a.target)})})}})})},orgrole:function(a,o){if(this.debug>0)console.log("ADMIN.orgrole(type, role)",a,o);require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"orgrole",type:a,role:o},{signalItem:w("#local_eduvidual_admin_orgrole"+a)})})},globalrole:function(a,o){if(this.debug>0)console.log("ADMIN.globalrole(type, role)",a,o);require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"globalrole",type:a,role:o},{signalItem:w("#local_eduvidual_admin_globalrole"+a)})})},modifylogin:function(a){if(this.debug>0)console.log("ADMIN.modifylogin(setto)",a);require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"modifylogin",setto:a},{signalItem:w("#local_eduvidual_admin_modifylogin")})})},moolevels:function(a){if(this.debug>0)console.log("ADMIN.moolevels()");var o=new Array;w.each(w("input[name='moolevels[]']:checked"),function(){o.push(w(this).val())});require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"moolevels",moolevels:o},{signalItem:w(a).parent()})})},org_gps:function(a,e,o,r,i){var t=this;t.refresh_identifier++;var n=t.refresh_identifier;if(typeof a==="undefined")a=w(".local_eduvidual_admin_map").attr("id");if(typeof e==="undefined")e=-200;if(typeof o==="undefined")o=200;if(typeof r==="undefined")r=-200;if(typeof i==="undefined")i=200;console.log("ADMIN.org_gps(uniqid, lon1, lon2, lat1, lat2)",a,e,o,r,i);var l=w("#"+a+"-include-nonegroup").prop("checked")?1:0;var u="local_eduvidual_admin_org_gps";var d={lon1:e,lon2:o,lat1:r,lat2:i,includenonegroup:l,advanceddata:0};if(typeof t.map!=="undefined"){t.map.remove()}if(t.debug_gps)console.log("Sending to "+u,d);s.call([{methodname:u,args:d,done:function(e){if(t.refresh_identifier!=n)return;try{e=JSON.parse(e)}catch(e){}if(t.debug_gps)console.log("Got response",e);t.orgs=e;t.org_gps_list(a)},fail:c.exception}])},org_gps_bounds:function(e){var a=this;if(typeof a.map==="undefined")return;var o=a.map.getBounds().toBBoxString().split(",");if(a.debug_gps)console.log("Setting bounds to",o);w("#"+e).attr("data-lon1",o[0]);w("#"+e).attr("data-lon2",o[2]);w("#"+e).attr("data-lat1",o[1]);w("#"+e).attr("data-lat2",o[3]);if(typeof a.map_moved==="undefined"){a.map_moved=0}else{a.map_moved++;var r=a.map_moved;setTimeout(function(){if(r==a.map_moved){a.org_gps_refresh(e)}},1e3)}},org_gps_list:function(o){var i=this;if(i.debug_gps)console.log("ADMIN.org_gps_list(uniqid)",o);if(typeof i.map!=="undefined"){i.map.remove()}var t=i.refresh_identifier;var n=w("#"+o+"-include-nonegroup").prop("checked")?1:0;w("#"+o+"-legend td.none").parent().css("display",n?"table-row":"none");w("#"+o+"-legend-none").css("display",n?"inline-block":"none");var l=i.orgs;var e=new Date(w("#"+o+"-year").val(),w("#"+o+"-month").val()-1,w("#"+o+"-day").val(),w("#"+o+"-hour").val(),w("#"+o+"-minute").val(),w("#"+o+"-second").val(),0);w("#"+o+"-second").val(e.getSeconds());w("#"+o+"-minute").val(e.getMinutes());w("#"+o+"-hour").val(e.getHours());w("#"+o+"-day").val(e.getDate());w("#"+o+"-month").val(e.getMonth()+1);w("#"+o+"-year").val(e.getFullYear());var u=Math.floor(e.getTime()/1e3);var d=200;var s=200;var c=-200;var g=-200;var f={both:0,eduv:0,none:0};var r=[L.layerGroup(),L.layerGroup(),L.layerGroup(),L.layerGroup()];var m={0:"",1:"Burgenland",2:"Kärnten",3:"Niederösterreich",4:"Oberösterreich",5:"Salzburg",6:"Steiermark",7:"Tirol",8:"Vorarlberg",9:"Wien"};var p={0:"Sonstige",1:"VS",2:"MS",3:"Sonderschule",4:"PTS",5:"BS",6:"Gymnasium",7:"HTL",8:"HAK",9:"HUM"};Object.keys(l).forEach(function(e){console.log("refresh_identifier",i.refresh_identifier,t);if(i.refresh_identifier!=t)return;l[e].url=D.relativeUrl("/local/eduvidual/pages/myorgs.php?orgid="+l[e].orgid);var a=l[e].orgid.toString().split("").pop();var o=l[e].orgid.toString().split("")[0];l[e].classes=p[a]+" "+m[o];var r="red";l[e].ignore=false;if(l[e].authenticated>0&&l[e].authenticated<u&&l[e].lpf!=null){r="orange";f.both++;l[e].classes+=" both";l[e].layer=2;l[e].url=D.relativeUrl("/local/eduvidual/pages/myorgs.php?orgid="+l[e].orgid)}else if(l[e].authenticated>0&&l[e].authenticated<u){r="green";f.eduv++;l[e].classes+=" eduv";l[e].layer=3;l[e].url=D.relativeUrl("/local/eduvidual/pages/myorgs.php?orgid="+l[e].orgid)}else if(n==1){r="lightgray";f.none++;l[e].classes+=" none invisible";l[e].layer=0;l[e].url=""}else{l[e].ignore=true}if(r!="lightgray"&&a>0){if(l[e].lon<s)s=l[e].lon;if(l[e].lon>g)g=l[e].lon;if(l[e].lat<d)d=l[e].lat;if(l[e].lat>c)c=l[e].lat}l[e].marker=D.relativeUrl("/local/eduvidual/pix/google-maps-pin-"+r+".svg#"+l[e].classes+"#"+l[e].layer)});d=45.18189988240382;s=8.88805461218309;c=49.517950306694665;g=17.45739054968309;var a=[[d,s],[c,g]];var v=(d+c)/2;var h=(s+g)/2;var _=[v,h];if(i.debug_gps)console.log("Bounds",a);if(i.debug_gps)console.log("Center",_);var b=w("#"+o+"-map").width();if(i.debug_gps)console.log("Width",b);if(i.debug_gps)console.log("Height",b/4*3);w("#"+o+"-map").css("height",b/4*3+"px");var y=L.icon({iconUrl:D.relativeUrl("/local/eduvidual/pix/google-maps-pin-blue.svg"),iconRetinaUrl:D.relativeUrl("/local/eduvidual/pix/google-maps-pin-blue.svg"),iconSize:[29,24],iconAnchor:[9,21],popupAnchor:[0,-14]});Object.keys(l).forEach(function(e){if(i.refresh_identifier!=t)return;if(l[e].ignore)return;var a=y;if(typeof l[e].marker!=="undefined"&&l[e].marker!=""){a=L.icon({iconUrl:l[e].marker,iconRetinaUrl:l[e].marker,iconSize:[29,24],iconAnchor:[9,21],popupAnchor:[0,-14]})}var o=L.marker([l[e].lat,l[e].lon],{icon:a}).bindPopup(typeof l[e].url!=="undefined"&&l[e].url!=""?'<a href="'+l[e].url+'" target="_blank">'+l[e].name+" ("+e+")</a>":l[e].name);o.addTo(r[l[e].layer])});var q=[e.getFullYear(),String(e.getMonth()+1).padStart(2,"0"),String(e.getDate()).padStart(2,"0")].join("-");var k=1/9*6;var I="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";var M="Visualisierung der Moodle-Schulen in Österreich | "+q+' | <a href="https://www.lernmanagement.at" target="_blank">Zentrum für Lernmanagement</a> | powered by &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>';i.map=L.map(o+"-map",{boxZoom:true,center:_,layers:r,zoom:14,zoomControl:false,zoomSnap:.5});i.map.fitBounds(a,{maxZoom:18});i.map.on("moveend",function(e){i.org_gps_bounds(o)});i.map.on("resize",function(e){if(i.debug_gps)console.log("Map was resized",e);var a=w("#"+o+"-map").width();if(i.debug_gps)console.log("Width",a);if(i.debug_gps)console.log("Height",a*k);w("#"+o+"-map").css("height",a*k+"px")});var A={normal:L.tileLayer(I,{attribution:M,id:"mapbox.normal",subdomains:["a","b","c"]})};A["normal"].addTo(i.map);L.control.zoom({position:"bottomright"}).addTo(i.map);w("#"+o+" .leaflet-marker-pane img").each(function(e,a){if(i.refresh_identifier!=t)return;var o=w(a).attr("src");var r=o.split("#");if(r.length==3){w(a).addClass(r[1].replace(","," "));w(a).css("z-index",990+r[2])}});w("#"+o+"-map").css("height",w("#"+o+"-map").width()*k+"px");i.org_gps_bounds(o);i.org_gps_refresh(o)},org_gps_refresh:function(l){var u=this;u.refresh_identifier++;var d=u.refresh_identifier;console.log("ADMIN.org_gps_refresh(uniqid)",l);var i=w("#"+l+"-map");w("#"+l+"-map .leaflet-marker-icon").each(function(e,a){if(u.refresh_identifier!=d)return;var o=a.style.transform.split(/\w+\(|\);?/);if(o.length==3){var r=o[1].split("px").join("").split(" ").join("").split(",")}if(r.length==3){if(r[0]<0||r[0]>i.width()||r[1]<0||r[1]>i.height()){w(a).addClass("out-of-bounds")}else{w(a).removeClass("out-of-bounds")}}});w("#"+l+"-map .leaflet-marker-icon").addClass("flag-visible");w("#"+l+"-legend .trigger").each(function(e,a){if(u.refresh_identifier!=d)return;var o=w(a).attr("data-trigger-key");if(typeof o!=="undefined"&&o!==""){var r=w(a).prop("checked");if(!r){w("#"+l+"-map .leaflet-marker-icon."+o).removeClass("flag-visible")}}});w("#"+l+"-map .leaflet-marker-icon:not(.flag-visible)").addClass("invisible");w("#"+l+"-map .leaflet-marker-icon.flag-visible").removeClass("invisible");var s=w("#"+l+"-count-invisibles").prop("checked");var c={};w("#"+l+"-legend .trigger").each(function(e,a){if(u.refresh_identifier!=d)return;var o=w(a).attr("data-trigger-key");var r=w(a).attr("data-filterid");if(typeof o!=="undefined"&&o!==""){var i=w(a).prop("checked");var t=0;var n=w("#"+l+"-map .leaflet-marker-icon."+o+":not(.out-of-bounds)");if(s){t=n.length}else if(i){t=n.not(".invisible").length}w("#"+l+"-legend td."+o).html(t);if(typeof r!=="undefined"&&r!=""){if(typeof c[r]==="undefined")c[r]=0;c[r]+=t}}});Object.keys(c).forEach(function(e){w("#"+l+"-legend table."+e+" td.sum").html(c[e])})},orgcoursebasement:function(a){if(this.debug>0)console.log("ADMIN.orgcoursebasement(basement)",a);require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"orgcoursebasement",basement:a},{signalItem:w("#local_eduvidual_admin_orgcoursebasement")})})},protectedorgs:function(){if(this.debug>0)console.log("ADMIN.protectedorgs()");require(["local_eduvidual/main"],function(e){e.watchValue({target:"#local_eduvidual_admin_protectedorgs",run:function(){var a=this;require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"protectedorgs",protectedorgs:w(a.target).val()},{signalItem:w(a.target)})})}})})},questioncategories:function(a,e){if(this.debug>0)console.log("ADMIN.questioncategories(uniqid, catid)",a,e);var o=w(".questioncategory-"+a+"-"+e);var r=new Array;var i=new Array;w.each(w(".questioncategories-"+a+":checked"),function(){var e=w(this).val();r.push(e);i.push(w(".supportcourses-"+a+"-"+e).val())});require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"questioncategories",questioncategories:r,supportcourses:i},{signalItem:w(o)})})},registrationcc:function(){if(this.debug>0)console.log("ADMIN.registrationcc()");require(["local_eduvidual/main"],function(e){e.watchValue({target:"#local_eduvidual_admin_registrationcc",run:function(){var a=this;require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"registrationcc",registrationcc:w(a.target).val()},{signalItem:w(a.target)})})}})})},registrationsupport:function(){if(this.debug>0)console.log("ADMIN.registrationsupport()");require(["local_eduvidual/main"],function(e){e.watchValue({target:"#local_eduvidual_admin_registrationsupport",run:function(){var a=this;require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"registrationsupport",registrationsupport:w(a.target).val()},{signalItem:w(a.target)})})}})})},requireCapability:function(a){if(this.debug>0)console.log("ADMIN.requireCapability(val)",a);require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"requirecapability",requirecapability:a},{signalItem:w("#local_eduvidual_admin_requirecapability")})})},result:function(e){if(e.data.act=="blockfooter"){w("#local_eduvidual_footer").html(e.data.blockfooter)}if(e.data.act=="coursebasements"){history.go(0)}if(e.data.act=="manageorgs_search"){if(typeof e.result.status!=="undefined"&&e.result.status=="ok"){var a=w("#"+e.payload.uniqid+"-list").empty();this.cache_orgs=e.result.orgs;if(e.result.orgs.length===0){a.append(w("<li>").html("No results"))}else{var o=Object.keys(e.result.orgs);for(var r=0;r<o.length;r++){var i=e.result.orgs[o[r]];a.append(w("<li>").append(w("<a>").html(i.name+" ("+i.orgid+")").attr("href","#").attr("onclick","require(['local_eduvidual/admin'], function(ADMIN) { ADMIN.manageorgs_open('"+e.payload.uniqid+"', "+i.id+"); });")))}}}}if(e.data.act=="manageorgs_store"){if(typeof e.result.errors!=="undefined"&&e.result.errors.length>0){for(var r=0;r<e.result.errors.length;r++){var t=e.result.errors[r];w("#"+e.payload.uniqid+"-field-"+t).addClass("local_eduvidual_signal_error")}}}},statsSwitchColumn:function(e,a){console.log("ADMIN.statsSwitchColumn(uniqid, sender)",e,a);var o=w(a).attr("data-type");var r=w("."+e+"-"+o);var i=w(a).prop("checked")?"block":"none";r.css("display",i)},supportcourseurl:function(){if(this.debug>0)console.log("ADMIN.supportcourseurl()");require(["local_eduvidual/main"],function(e){e.watchValue({target:"#local_eduvidual_admin_supportcourseurl",run:function(){var a=this;require(["local_eduvidual/main"],function(e){e.connect({module:"admin",act:"supportcourseurl",supportcourseurl:w(a.target).val()},{signalItem:w(a.target)})})}})})}}});