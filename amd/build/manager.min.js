define("local_eduvidual/manager",["jquery","core/ajax","core/modal_events","core/modal_factory","core/notification","core/str","core/url","local_eduvidual/main","local_eduvidual/user","local_eduvidual/widgets"],(function($,AJAX,ModalEvents,ModalFactory,NOTIFICATION,STR,URL,MAIN,USER,WIDGETS){return{addParentFilterRequest:0,customcsscache:"",debug:1,sync_queue_create:[],addParentFilter:function(type,inp){console.log("local_eduvidual/main:addParentFilter(type, inp)",type,inp),this.addParentFilterRequest++;var studentid,orgid=$("#local_eduvidual_manage_addparent_studentfilter").attr("data-orgid"),select=$("#local_eduvidual_manage_addparent_"+type);$(select).empty(),0==$(inp).val().length&&$(inp).val("*"),studentid=$("#local_eduvidual_manage_addparent_student").val();var addParentFilterRequest=this.addParentFilterRequest;require(["local_eduvidual/main"],(function(MAIN){MAIN.connect({module:"manage",act:"addparent_filter",orgid:orgid,filter:$(inp).val(),studentid:studentid},{signalItem:inp,appendItem:select,type:type,request:addParentFilterRequest})}))},addParentSelectStudent:function(){this.addParentFilter("parent",$("#local_eduvidual_manage_addparent_parentfilter"))},addParent:function(inp){var orgid=$("#local_eduvidual_manage_addparent_studentfilter").attr("data-orgid"),studentid=$("#local_eduvidual_manage_addparent_student").val(),parentid=$("#local_eduvidual_manage_addparent_parent").val();studentid>0&&parentid>0&&require(["local_eduvidual/main"],(function(MAIN){MAIN.connect({module:"manage",act:"addparent",orgid:orgid,studentid:studentid,parentid:parentid},{signalItem:inp})}))},addUser:function(secret){void 0===secret&&(secret=$("#local_eduvidual_manage_adduser").val());var role=$("#local_eduvidual_manage_adduser_role").val(),orgid=$("#local_eduvidual_manage_adduser").attr("data-orgid");require(["local_eduvidual/main"],(function(MAIN){MAIN.connect({module:"manage",act:"adduser",orgid:orgid,role:role,secret:secret},{signalItem:$("#local_eduvidual_manage_adduser")})}))},addUserAnonymous:function(){var orgid=+$("#local_eduvidual_manage_createuseranonymous_orgid").val(),role=$("#local_eduvidual_manage_createuseranonymous_role").val(),amount=+$("#local_eduvidual_manage_createuseranonymous_amount").val(),cohorts=$("#local_eduvidual_manage_createuseranonymous_cohorts").val();amount>50?STR.get_strings([{key:"manage:createuseranonymous:exceededmax:title",component:"local_eduvidual"},{key:"manage:createuseranonymous:exceededmax:text",component:"local_eduvidual",param:{maximum:50}}]).done((function(s){NOTIFICATION.alert(s[0],s[1])})).fail(NOTIFICATION.exception):require(["local_eduvidual/main"],(function(MAIN){MAIN.connect({module:"manage",act:"adduser_anonymous",orgid:orgid,role:role,amount:amount,cohorts:cohorts},{signalItem:$("#local_eduvidual_manage_adduseranonymous_btn")})}))},categoryAdd:function(src,orgid,parentid){if(void 0!==src)for(var li=$(src);!$(li).is("li");)li=$(li).parent();void 0===orgid&&(orgid=+$(".ul-eduvidual-courses").attr("data-orgid")),void 0===parentid&&(parentid=+li.attr("data-categoryid"));var runnable={orgid:orgid,li:li,parentid:parentid,run:function(name){var o=this;null!==name&&name.length>2?require(["local_eduvidual/main"],(function(MAIN){MAIN.connect({module:"manage",act:"addcategory",orgid:o.orgid,parentid:o.parentid,name:name},{parent:o.li})})):null!==name&&STR.get_strings([{key:"categoryadd:title:length:title",component:"local_eduvidual"},{key:"categoryadd:title:length:text",component:"local_eduvidual"}]).done((function(s){NOTIFICATION.alert(s[0],s[1])})).fail(NOTIFICATION.exception)}};console.log(runnable);var prompt=WIDGETS.prompt();STR.get_strings([{key:"categoryadd:title",component:"local_eduvidual"},{key:"categoryadd:text",component:"local_eduvidual"}]).done((function(s){prompt.create(s[0],s[1],"",runnable)})).fail(NOTIFICATION.exception)},categoryEdit:function(src,orgid,parentid,currentname){if(void 0!==src)for(var li=$(src);!$(li).is("li");)li=$(li).parent();void 0===orgid&&(orgid=+$(".ul-eduvidual-courses").attr("data-orgid")),void 0===parentid&&(parentid=+li.attr("data-categoryid")),void 0===currentname&&(currentname="");var runnable={orgid:orgid,li:li,parentid:parentid,run:function(name){var o=this;null!==name&&name.length>2?require(["local_eduvidual/main"],(function(MAIN){MAIN.connect({module:"manage",act:"editcategory",orgid:o.orgid,parentid:o.parentid,name:name},{parent:o.li})})):null!==name&&STR.get_strings([{key:"categoryedit:title:length:title",component:"local_eduvidual"},{key:"categoryedit:title:length:text",component:"local_eduvidual"}]).done((function(s){NOTIFICATION.alert(s[0],s[1])})).fail(NOTIFICATION.exception)}};console.log(runnable);var prompt=WIDGETS.prompt();STR.get_strings([{key:"categoryadd:title",component:"local_eduvidual"},{key:"categoryadd:text",component:"local_eduvidual"}]).done((function(s){prompt.create(s[0],s[1],currentname,runnable)})).fail(NOTIFICATION.exception)},categoryRemove:function(src,confirm,orgid,parentid){if(void 0!==confirm&&confirm){if(void 0===orgid&&(orgid=+$(".ul-eduvidual-courses").attr("data-orgid")),void 0===parentid){for(var li=$(src);!$(li).is("li");)li=$(li).parent();parentid=+li.attr("data-categoryid")}require(["local_eduvidual/main"],(function(MAIN){MAIN.connect({module:"manage",act:"removecategory",orgid:orgid,parentid:parentid},{parent:li})}))}else{var MANAGER=this;STR.get_strings([{key:"categoryremove:title",component:"local_eduvidual"},{key:"categoryremove:text",component:"local_eduvidual"},{key:"yes"},{key:"no"}]).done((function(s){NOTIFICATION.confirm(s[0],s[1],s[2],s[3],(function(){MANAGER.categoryRemove(src,!0,orgid,parentid)}))})).fail(NOTIFICATION.exception)}},createAccesscode:function(){var code=$("#local_eduvidual_manage_accesscode_code").val(),orgid=+$("#local_eduvidual_manage_adduser").attr("data-orgid"),maturity=$("#local_eduvidual_manage_accesscode_maturity").val(),role=$("#local_eduvidual_manage_accesscode_role").val();require(["local_eduvidual/main"],(function(MAIN){MAIN.connect({module:"manage",act:"accesscode_create",orgid:orgid,code:code,role:role,maturity:maturity},{signalItem:$("#local_eduvidual_manage_accesscode_btn")})}))},createUsers:function(uniqid,item){this.debug>0&&console.log("local_eduvidual/manager::createUsers(uniqid, item)",uniqid,item);var MAIN=this;if(item){var tr=item.tr,import_data=item.import_data;$(tr).css("filter","blur(2px)"),console.debug(item),AJAX.call([{methodname:"local_eduvidual_manager_create_users",args:import_data,done:function(result){if($(tr).css("filter","unset"),MAIN.debug>0&&console.log("=> Result for "+uniqid,result),1==result.status&&$(tr).find(".process-indicator").attr("src","/pix/i/completion-auto-pass.svg"),0==result.status&&$(tr).find(".process-indicator").attr("src","/pix/i/completion-auto-y.svg"),-1==result.status&&($(tr).css("background-color","rgba(255,0,0,0.1)"),$(tr).find(".process-indicator").attr("src","/pix/i/completion-auto-fail.svg")),result.message.length>0&&$(tr).find(".action").html(result.message),MAIN.sync_queue_create.length>0){var queueitem=MAIN.sync_queue_create.shift();MAIN.createUsers(queueitem.uniqid,queueitem.item)}else $(".import-btn-"+uniqid).removeClass("disabled")},fail:Notification.exception}])}else if($(".import-btn-"+uniqid).addClass("disabled"),$("."+uniqid+" tr.user").each((function(){var import_data=$(this).data("import_data");MAIN.sync_queue_create.push({uniqid:uniqid,item:{import_data:import_data,tr:this}})})),MAIN.sync_queue_create.length>0){var queueitem=MAIN.sync_queue_create.shift();MAIN.createUsers(queueitem.uniqid,queueitem.item)}},customcss:function(){var orgid=$("#local_eduvidual_manage_customcss").attr("data-orgid");require(["local_eduvidual/main"],(function(MAIN){MAIN.watchValue({target:"#local_eduvidual_manage_customcss",orgid:orgid,run:function(){MAIN.connect({module:"manage",act:"customcss",orgid:this.orgid,customcss:$(this.target).val()},{signalItem:$(this.target)})}})}))},editProfile:function(orgid,userid,callback){STR.get_strings([{key:"profile",component:"core"}]).done((function(s){var data={orgid:orgid,userid:userid};AJAX.call([{methodname:"local_eduvidual_manager_user_form",args:data,done:function(formhtml){ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:s[0],body:formhtml}).then((function(modal){var root=modal.getRoot();root.on(ModalEvents.save,(function(e){e.preventDefault();var data={orgid:orgid,userid:userid,firstname:$(root).find('[name="firstname"]').val(),lastname:$(root).find('[name="lastname"]').val(),email:$(root).find('[name="email"]').val()};AJAX.call([{methodname:"local_eduvidual_manager_user_update",args:data,done:function(result){console.log("saved",result),void 0!==result.success&&1==result.success&&(modal.hide(),void 0!==callback&&void 0!==callback.run&&callback.run()),void 0!==result.message&&NOTIFICATION.alert(result.subject,result.message)},fail:NOTIFICATION.exception}])})),modal.show()}))},fail:NOTIFICATION.exception}])})).fail(NOTIFICATION.exception)},exportUserPopup:function(orgid,userids){this.debug>0&&console.log("local_eduvidual/manager:exportUserPopup(orgid, userids)",orgid,userids),AJAX.call([{methodname:"local_eduvidual_manager_user_exportform",args:{orgid:orgid,userids:userids},done:function(formhtml){ModalFactory.create({title:STR.get_string("export","local_eduvidual"),type:ModalFactory.types.SAVE_CANCEL,body:formhtml}).done((function(modal){var root=modal.getRoot();root.on(ModalEvents.save,(function(e){e.preventDefault(),modal.hide(),$(root).find("form").submit(),$(root).remove()})),STR.get_strings([{key:"export",component:"local_eduvidual"}]).done((function(s){$(root).find('.modal-footer button[data-action="save"]').html(s[0])})),$(root).find('button[type="submit"]').remove(),modal.show()}))},fail:NOTIFICATION.exception}])},forceEnrol:function(courseid){require(["local_eduvidual/main"],(function(MAIN){MAIN.connect({module:"manage",act:"force_enrol",courseid:courseid},{})}))},maildomain:function(inp,orgid,type){this.debug>0&&console.log("MANAGER.maildomain(inp, orgid, type)",inp,orgid,type),require(["local_eduvidual/main"],(function(MAIN){MAIN.watchValue({orgid:orgid,target:$(inp),type:type,run:function(){var o=this;require(["local_eduvidual/main"],(function(MAIN){MAIN.connect({module:"manage",act:"maildomain",orgid:o.orgid,type:o.type,maildomain:$(o.target).val()},{signalItem:$(o.target)})}))}})}))},maildomain_apply:function(orgid,btn){this.debug>0&&console.log("MANAGER.maildomain_apply(orgid, btn)",orgid,btn),require(["local_eduvidual/main"],(function(MAIN){MAIN.connect({module:"manage",act:"maildomain_apply",orgid:orgid},{signalItem:$(btn)})}))},overrideBBB:function(uniqid,signalitem){var orgid=$("#orgid-"+uniqid).val(),bbb_serverurl=$(".bbb_serverurl-"+uniqid).val(),bbb_sharedsecret=$(".bbb_sharedsecret-"+uniqid).val();require(["local_eduvidual/main"],(function(MAIN){MAIN.connect({module:"manage",act:"override_bigbluebutton",orgid:orgid,bbb_serverurl:bbb_serverurl,bbb_sharedsecret:bbb_sharedsecret},{signalItem:$(signalitem)})}))},overrideRolenames:function(uniqid,signalitem){var orgid=$("#orgid-"+uniqid).val(),roles=[];$(".overriderole-"+uniqid).each((function(){roles[roles.length]={roleid:$(this).attr("data-roleid"),override:$(this).val()}})),require(["local_eduvidual/main"],(function(MAIN){MAIN.connect({module:"manage",act:"override_rolenames",orgid:orgid,roles:JSON.stringify(roles)},{signalItem:$(signalitem)})}))},setpwforcechange:function(){var orgid=$("#local_eduvidual_manage_adduser").attr("data-orgid"),secrets=($("#local_eduvidual_manage_setuserrole_role").val(),[]);$('#local_eduvidual_manage_setuserrole_user option:selected:not([value=""])').each((function(){secrets.push($(this).val())})),0!=secrets.length&&require(["local_eduvidual/main"],(function(MAIN){MAIN.connect({module:"manage",act:"setpwforcechange",orgid:orgid,secrets:secrets},{signalItem:$("#local_eduvidual_manage_setuserforcechange")})}))},setpwreset:function(){var orgid=$("#local_eduvidual_manage_adduser").attr("data-orgid"),secrets=($("#local_eduvidual_manage_setuserrole_role").val(),[]);$('#local_eduvidual_manage_setuserrole_user option:selected:not([value=""])').each((function(){secrets.push($(this).val())})),0!=secrets.length&&require(["local_eduvidual/main"],(function(MAIN){MAIN.connect({module:"manage",act:"setpwreset",orgid:orgid,secrets:secrets},{signalItem:$("#local_eduvidual_manage_setuserrole")})}))},setuserrole:function(){var orgid=$("#local_eduvidual_manage_adduser").attr("data-orgid"),role=$("#local_eduvidual_manage_setuserrole_role").val(),secrets=[];$('#local_eduvidual_manage_setuserrole_user option:selected:not([value=""])').each((function(){secrets.push($(this).val())})),0!=secrets.length&&require(["local_eduvidual/main"],(function(MAIN){MAIN.connect({module:"manage",act:"setuserrole",orgid:orgid,role:role,secrets:secrets},{signalItem:$("#local_eduvidual_manage_setuserrole")})}))},setuserrole_search:function(marksuccess,markfailed){var orgid=$("#local_eduvidual_manage_adduser").attr("data-orgid"),search=$("#local_eduvidual_manage_setuserrole_search").val();search.length<2||require(["local_eduvidual/main"],(function(MAIN){MAIN.connect({module:"manage",act:"setuserrole_search",orgid:orgid,search:search},{marksuccess:marksuccess,markfailed:markfailed})}))},result:function(o){if("accesscode_create"==o.data.act&&"ok"==o.result.status&&(top.location.href=URL.relativeUrl("/local/eduvidual/pages/manage.php",{orgid:o.data.orgid,act:"users",tab:"accesscodes"})),"accesscode_revoke"==o.data.act&&"ok"==o.result.status&&(top.location.href=URL.relativeUrl("/local/eduvidual/pages/manage.php",{orgid:o.data.orgid,act:"users",tab:"accesscodes"})),"addcategory"==o.data.act&&(require(["local_eduvidual/main"],(function(MAIN){MAIN.confirmed('.ul-eduvidual-courses li[data-categoryid="'+o.data.parentid+'"]',"ok"==o.result.status)})),"ok"==o.result.status&&(void 0===o.payload.parent?require(["local_eduvidual/user"],(function(USER){USER.loadCategory(o.data.parentid,o.data.orgid)})):top.location.href=top.location.href)),"addparent"==o.data.act&&this.addParentSelectStudent(),"addparent_filter"==o.data.act){if(o.payload.request!=this.addParentFilterRequest)return;$(o.payload.appendItem).empty();var keys=Object.keys(o.result.users);if(keys.length>0)for(var a=0;a<keys.length;a++){var u=o.result.users[keys[a]],state="";"parent"==o.payload.type&&(state=void 0!==u.isparent&&u.isparent?"+ ":"- "),$(o.payload.appendItem).append($("<option>").html(state+u.userfullname+" ("+u.email+")").attr("value",u.id))}}if("adduser"!=o.data.act&&"setuserrole"!=o.data.act||("ok"==o.result.status&&($("#local_eduvidual_manage_"+o.data.act).val("ok"),setTimeout((function(){$("#local_eduvidual_manage_"+o.data.act).val("")}),500)),this.setuserrole_search()),"adduser_anonymous"==o.data.act&&($("#local_eduvidual_manage_createuseranonymous_success span").html(o.result.success),$("#local_eduvidual_manage_createuseranonymous_failed span").html(o.result.failed),$("#local_eduvidual_manage_createuseranonymous_success").css("display",o.result.success>0?"block":"none"),$("#local_eduvidual_manage_createuseranonymous_failed").css("display",o.result.failed>0?"block":"none"),$("#local_eduvidual_manage_createuseranonymous_success input").attr("data-bunch",o.data.bunch)),"customcss"==o.data.act&&$("#local_eduvidual_style_org").html(o.data.customcss),"force_enrol"==o.data.act&&"ok"==o.result.status&&(top.location.href=URL.fileUrl("/course/view.php","")+"?id="+o.data.courseid),"maildomain_apply"==o.data.act&&void 0!==o.result.updated&&alert("Updated "+o.result.updated.Teacher+" Teachers and "+o.result.updated.Student+" Students"),"removecategory"!=o.data.act&&"editcategory"!=o.data.act||(require(["local_eduvidual/main"],(function(MAIN){MAIN.confirmed('.ul-eduvidual-courses li[data-categoryid="'+o.data.parentid+'"]',"ok"==o.result.status)})),"ok"==o.result.status&&(void 0===o.payload.parent?require(["local_eduvidual/user"],(function(USER){USER.loadCategory(void 0!==o.result.removedcat?o.result.removedcat.parent:o.result.editedcat.id,o.data.orgid)})):"removecategory"==o.data.act?setTimeout((function(){$('.ul-eduvidual-courses li[data-categoryid="'+o.data.parentid+'"]').remove()}),500):"editcategory"==o.data.act&&$('.ul-eduvidual-courses li[data-categoryid="'+o.data.parentid+'"]>label>span').html(o.data.name))),console.log(o),"setpwreset"==o.data.act&&STR.get_strings([{key:"manage:users:setpwreset",component:"local_eduvidual"}]).done((function(s){require(["core/modal_factory","core/templates"],(function(ModalFactory,Templates){ModalFactory.create({title:s[0],body:Templates.render("local_eduvidual/manage_setpwreset_modal",{failed:o.result.failed.join(", "),hasfailed:o.result.failed.length,hasupdated:o.result.updated.length,updated:o.result.updated.join(", ")}),footer:""}).done((function(modal){modal.show()}))}))})).fail(NOTIFICATION.exception),"setuserrole_search"==o.data.act&&void 0!==o.result.users){$('#local_eduvidual_manage_setuserrole_user option:not([value=""])').remove();for(a=0;a<o.result.users.length;a++){var s=$("<option>").attr("value",o.result.users[a].secret).html(o.result.users[a].userfullname+(""!=o.result.users[a].email?" ("+o.result.users[a].email+")":""));$("#local_eduvidual_manage_setuserrole_user").append(s)}var updated=o.payload.marksuccess;void 0!==updated&&updated.length>0&&require(["local_eduvidual/main"],(function(MAIN){for(var a=0;a<updated.length;a++)MAIN.signal({signalItem:$('#local_eduvidual_manage_setuserrole_user option[value="'+updated[a]+'"]')},void 0,"success")}));var failed=o.payload.markfailed;if(void 0!==failed&&failed.length>0)for(a=0;a<failed.length;a++)require(["local_eduvidual/main"],(function(MAIN){MAIN.signal({signalItem:$('#local_eduvidual_manage_setuserrole_user option[value="'+failed[a]+'"]')},void 0,"success")}))}},revokeAccesscode:function(id){var orgid=+$("#local_eduvidual_manage_adduser").attr("data-orgid");require(["local_eduvidual/main"],(function(MAIN){MAIN.connect({module:"manage",act:"accesscode_revoke",orgid:orgid,id:id},{})}))}}}));

//# sourceMappingURL=manager.min.js.map